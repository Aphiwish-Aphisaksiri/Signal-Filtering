% Load the ECG signal from the .mat file
load('noisyecg/noisyecg.mat');

% Compute the power spectral density using pwelch
fs = 500; % Sampling frequency (Hz)
window = hamming(1024); % Window function
noverlap = 512; % Number of samples to overlap
nfft = 1024; % Number of FFT points
[Pxx_original, f] = pwelch(ecg1, window, noverlap, nfft, fs);

b = [-0.00146956366081349,0.000750787558623087,0.000673019868646810,0.000613201635557846,0.000520999739509286,0.000376638409689291,0.000194491036464744,1.64980013626498e-05,-0.000107714660969257,-0.000141709856511225,-8.05725895248595e-05,4.56016147372247e-05,0.000180419156423148,0.000263782045921784,0.000254622853669727,0.000149734666321314,-1.48053479850250e-05,-0.000175504026172327,-0.000267875910613361,-0.000251468174970315,-0.000129303831400441,5.30728996784075e-05,0.000222638091534028,0.000309447752308386,0.000273546074630267,0.000124803265946584,-8.13384022781732e-05,-0.000262217547898392,-0.000343386952737538,-0.000286664141690885,-0.000110597118661337,0.000118621159083374,0.000307906376966926,0.000379817911771159,0.000297844091606716,9.33182139836647e-05,-0.000161084622277972,-0.000355699018514948,-0.000413821643051412,-0.000307762289255960,-6.90022848203136e-05,0.000207050545062074,0.000409119275143018,0.000450785867206901,0.000310346252851304,3.76481525067478e-05,-0.000260239086382009,-0.000463276666540948,-0.000484447620574050,-0.000308805909787404,-3.90431304882729e-07,0.000319256934011200,0.000520367837521974,0.000516150349803366,0.000301201954925077,-4.45286665116588e-05,-0.000384290204934727,-0.000579408017128758,-0.000544890140149814,-0.000286907242137614,9.72250268797376e-05,0.000455044193802384,0.000639734129923803,0.000569836890706221,0.000265126590944242,-0.000158155123393343,-0.000531508184010256,-0.000700790794447606,-0.000590249080976828,-0.000235127347606018,0.000227464075209000,0.000613221930244820,0.000761582104635900,0.000604333497041303,0.000196504144204865,-0.000306106299126284,-0.000699484131870700,-0.000820804379335146,-0.000611778846864348,-0.000147255394906416,0.000392723477167878,0.000790036280656342,0.000878461784502218,0.000611595248384110,8.72805392530601e-05,-0.000489399158462166,-0.000884844980947944,-0.000932647383872813,-0.000602001321175303,-1.59299857605122e-05,0.000595218779343772,0.000983060275184858,0.000982971516997730,0.000582557552457626,-6.73546351334840e-05,-0.000710151614314862,-0.00108368348413090,-0.00102780662762303,-0.000551763524482709,0.000163346933063897,0.000833993221994713,0.00118567956789108,0.00106567100963461,0.000508261793567107,-0.000272829721685896,-0.000966707373061499,-0.00128814493165979,-0.00109535722765453,-0.000450686711090543,0.000396299740803788,0.00110830024847404,0.00139023106409438,0.00111523387753399,0.000378235754631169,-0.000534812541802285,-0.00125797429842117,-0.00149073577964607,-0.00112410181274973,-0.000289196425367175,0.000688086235007910,0.00141484205351335,0.00158769748645620,0.00112002421007382,0.000182638129017156,-0.000856848581206995,-0.00157883044724505,-0.00167991307352779,-0.00110076245769252,-5.64131891719020e-05,0.00104191695658635,0.00174929675290403,0.00176608560936952,0.00106507711438540,-9.03145666877095e-05,-0.00124341977790139,-0.00192538372866917,-0.00184446941865671,-0.00101095074824626,0.000258964045588547,0.00146150013601083,0.00210584122637874,0.00191268289366297,0.000935803827771273,-0.000451605116350241,-0.00169690261163108,-0.00228990791160006,-0.00196889834951741,-0.000837104789803323,0.000669868814666609,0.00195050231794505,0.00247681250600800,0.00201120310260774,0.000712877294262026,-0.000915841391021316,-0.00222242306219979,-0.00266529707751117,-0.00203697160574739,-0.000559803127313703,0.00119185932295628,0.00251355130047004,0.00285393227179226,0.00204305388557241,0.000374334198096651,-0.00150074145527934,-0.00282523097258313,-0.00304220075885224,-0.00202700789069019,-0.000152831051595764,0.00184569242670508,0.00315854420019402,0.00322841500628165,0.00198495724625271,-0.000109441007206049,-0.00223071385811161,-0.00351523445176778,-0.00341115353809070,-0.00191234940267404,0.000418729575153213,0.00266163150294560,0.00389858120844881,0.00358965552309564,0.00180473474708162,-0.000781922080944620,-0.00314481360287516,-0.00431198923406674,-0.00376246022537532,-0.00165551645067915,0.00120826979592372,0.00368948594043850,0.00476033350456330,0.00392805753986893,0.00145651728281531,-0.00171076614031736,-0.00430852863112638,-0.00525173276709091,-0.00408576112681339,-0.00119753389767065,0.00230603163227524,0.00501910809899812,0.00579671240205931,0.00423393065090090,0.000863482105339095,-0.00301848783101285,-0.00584656530309774,-0.00641152503195902,-0.00437166303071006,-0.000433615736035750,0.00388370733497159,0.00682904121456583,0.00712130094208454,0.00449831198145817,-0.000122815147499192,-0.00495509753928582,-0.00802430728378493,-0.00796446400662481,-0.00461202879309502,0.000855868379967926,0.00632058880763171,0.00952909468577409,0.00900701396649281,0.00471263676680108,-0.00184818585868506,-0.00812932034380732,-0.0115110662130916,-0.0103654940813006,-0.00479926386126573,0.00325162314574246,0.0106616004263114,0.0142913381392151,0.0122684830303920,0.00487074819554742,-0.00537864680059248,-0.0145105626644595,-0.0185720215966777,-0.0152338953808196,-0.00492753432636512,0.00898584227296649,0.0211806782153242,0.0262242361900827,0.0207195235769374,0.00496771867518998,-0.0165166223551356,-0.0359456547653422,-0.0444751704840109,-0.0350534938394877,-0.00499265219873832,0.0426223613604143,0.0992314538059689,0.152820477905878,0.191115269726527,0.205000343233762,0.191115269726527,0.152820477905878,0.0992314538059689,0.0426223613604143,-0.00499265219873832,-0.0350534938394877,-0.0444751704840109,-0.0359456547653422,-0.0165166223551356,0.00496771867518998,0.0207195235769374,0.0262242361900827,0.0211806782153242,0.00898584227296649,-0.00492753432636512,-0.0152338953808196,-0.0185720215966777,-0.0145105626644595,-0.00537864680059248,0.00487074819554742,0.0122684830303920,0.0142913381392151,0.0106616004263114,0.00325162314574246,-0.00479926386126573,-0.0103654940813006,-0.0115110662130916,-0.00812932034380732,-0.00184818585868506,0.00471263676680108,0.00900701396649281,0.00952909468577409,0.00632058880763171,0.000855868379967926,-0.00461202879309502,-0.00796446400662481,-0.00802430728378493,-0.00495509753928582,-0.000122815147499192,0.00449831198145817,0.00712130094208454,0.00682904121456583,0.00388370733497159,-0.000433615736035750,-0.00437166303071006,-0.00641152503195902,-0.00584656530309774,-0.00301848783101285,0.000863482105339095,0.00423393065090090,0.00579671240205931,0.00501910809899812,0.00230603163227524,-0.00119753389767065,-0.00408576112681339,-0.00525173276709091,-0.00430852863112638,-0.00171076614031736,0.00145651728281531,0.00392805753986893,0.00476033350456330,0.00368948594043850,0.00120826979592372,-0.00165551645067915,-0.00376246022537532,-0.00431198923406674,-0.00314481360287516,-0.000781922080944620,0.00180473474708162,0.00358965552309564,0.00389858120844881,0.00266163150294560,0.000418729575153213,-0.00191234940267404,-0.00341115353809070,-0.00351523445176778,-0.00223071385811161,-0.000109441007206049,0.00198495724625271,0.00322841500628165,0.00315854420019402,0.00184569242670508,-0.000152831051595764,-0.00202700789069019,-0.00304220075885224,-0.00282523097258313,-0.00150074145527934,0.000374334198096651,0.00204305388557241,0.00285393227179226,0.00251355130047004,0.00119185932295628,-0.000559803127313703,-0.00203697160574739,-0.00266529707751117,-0.00222242306219979,-0.000915841391021316,0.000712877294262026,0.00201120310260774,0.00247681250600800,0.00195050231794505,0.000669868814666609,-0.000837104789803323,-0.00196889834951741,-0.00228990791160006,-0.00169690261163108,-0.000451605116350241,0.000935803827771273,0.00191268289366297,0.00210584122637874,0.00146150013601083,0.000258964045588547,-0.00101095074824626,-0.00184446941865671,-0.00192538372866917,-0.00124341977790139,-9.03145666877095e-05,0.00106507711438540,0.00176608560936952,0.00174929675290403,0.00104191695658635,-5.64131891719020e-05,-0.00110076245769252,-0.00167991307352779,-0.00157883044724505,-0.000856848581206995,0.000182638129017156,0.00112002421007382,0.00158769748645620,0.00141484205351335,0.000688086235007910,-0.000289196425367175,-0.00112410181274973,-0.00149073577964607,-0.00125797429842117,-0.000534812541802285,0.000378235754631169,0.00111523387753399,0.00139023106409438,0.00110830024847404,0.000396299740803788,-0.000450686711090543,-0.00109535722765453,-0.00128814493165979,-0.000966707373061499,-0.000272829721685896,0.000508261793567107,0.00106567100963461,0.00118567956789108,0.000833993221994713,0.000163346933063897,-0.000551763524482709,-0.00102780662762303,-0.00108368348413090,-0.000710151614314862,-6.73546351334840e-05,0.000582557552457626,0.000982971516997730,0.000983060275184858,0.000595218779343772,-1.59299857605122e-05,-0.000602001321175303,-0.000932647383872813,-0.000884844980947944,-0.000489399158462166,8.72805392530601e-05,0.000611595248384110,0.000878461784502218,0.000790036280656342,0.000392723477167878,-0.000147255394906416,-0.000611778846864348,-0.000820804379335146,-0.000699484131870700,-0.000306106299126284,0.000196504144204865,0.000604333497041303,0.000761582104635900,0.000613221930244820,0.000227464075209000,-0.000235127347606018,-0.000590249080976828,-0.000700790794447606,-0.000531508184010256,-0.000158155123393343,0.000265126590944242,0.000569836890706221,0.000639734129923803,0.000455044193802384,9.72250268797376e-05,-0.000286907242137614,-0.000544890140149814,-0.000579408017128758,-0.000384290204934727,-4.45286665116588e-05,0.000301201954925077,0.000516150349803366,0.000520367837521974,0.000319256934011200,-3.90431304882729e-07,-0.000308805909787404,-0.000484447620574050,-0.000463276666540948,-0.000260239086382009,3.76481525067478e-05,0.000310346252851304,0.000450785867206901,0.000409119275143018,0.000207050545062074,-6.90022848203136e-05,-0.000307762289255960,-0.000413821643051412,-0.000355699018514948,-0.000161084622277972,9.33182139836647e-05,0.000297844091606716,0.000379817911771159,0.000307906376966926,0.000118621159083374,-0.000110597118661337,-0.000286664141690885,-0.000343386952737538,-0.000262217547898392,-8.13384022781732e-05,0.000124803265946584,0.000273546074630267,0.000309447752308386,0.000222638091534028,5.30728996784075e-05,-0.000129303831400441,-0.000251468174970315,-0.000267875910613361,-0.000175504026172327,-1.48053479850250e-05,0.000149734666321314,0.000254622853669727,0.000263782045921784,0.000180419156423148,4.56016147372247e-05,-8.05725895248595e-05,-0.000141709856511225,-0.000107714660969257,1.64980013626498e-05,0.000194491036464744,0.000376638409689291,0.000520999739509286,0.000613201635557846,0.000673019868646810,0.000750787558623087,-0.00146956366081349];

% Normalize the filter coefficients
b = b / sum(b);

% Filter the signal with b
filtered_signal = filter(b, 1, ecg1);

% Compute the power spectral density of the filtered signal
[Pxx_filtered, f_filtered] = pwelch(filtered_signal, window, noverlap, nfft, fs);

% Plot the power spectral density of both signals
hold on;
plot(f, 10*log10(Pxx_original), 'b', 'LineWidth', 1.5);
plot(f_filtered, 10*log10(Pxx_filtered), 'r', 'LineWidth', 1.5);
hold off;

xlabel('Frequency (Hz)');
ylabel('Power Spectral Density (dB/Hz)');
title('Comparison of Power Spectral Density');
legend('Original Signal', 'Filtered Signal');
grid on;

% Plot the time domain comparison of the original and filtered signal
figure;

% Plot the original signal
subplot(2, 1, 1);
t = (0:length(ecg1)-1) / fs; % Time vector
plot(t, ecg1, 'b', 'LineWidth', 1.5);
xlabel('Time (s)');
ylabel('Amplitude');
title('Original Signal');
grid on;

% Plot the filtered signal
subplot(2, 1, 2);
plot(t, filtered_signal, 'r', 'LineWidth', 1.5);
xlabel('Time (s)');
ylabel('Amplitude');
title('Filtered Signal');
grid on;
