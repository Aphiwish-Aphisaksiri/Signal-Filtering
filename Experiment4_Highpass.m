% Load the ECG signal from the .mat file
load('noisyecg/noisyecg.mat');

% Compute the power spectral density using pwelch
fs = 500; % Sampling frequency (Hz)
window = hamming(1024); % Window function
noverlap = 512; % Number of samples to overlap
nfft = 1024; % Number of FFT points
[Pxx_original, f] = pwelch(ecg1, window, noverlap, nfft, fs);

b = [-0.000741923098680347,-7.57903642155869e-05,-7.95954838563659e-05,-8.34319136996970e-05,-8.73605121160509e-05,-9.13057332852977e-05,-9.53274926874703e-05,-9.93471212987854e-05,-0.000103420615461646,-0.000107471057875890,-0.000111558728017565,-0.000115603071499458,-0.000119675725992680,-0.000123686613660403,-0.000127733904568083,-0.000131721224054881,-0.000135749879413907,-0.000139722563575746,-0.000143750091166411,-0.000147701206615170,-0.000151691911348995,-0.000155563379696214,-0.000159423339383077,-0.000163077402430541,-0.000166672547968535,-0.000170003610870512,-0.000173344497693314,-0.000176506400862890,-0.000179968089096157,-0.000183353814877827,-0.000187043625374363,-0.000188380534139389,-0.000191723951020194,-0.000194365824479820,-0.000196530327547286,-0.000198823106324227,-0.000200721717402619,-0.000202591272788022,-0.000204126192811626,-0.000205567591619151,-0.000206690532999232,-0.000207666342939293,-0.000208320433431508,-0.000208778412650107,-0.000208914361672236,-0.000208818909232947,-0.000208394590055460,-0.000207729936684048,-0.000206744314986457,-0.000205500615814646,-0.000203938468290465,-0.000202089979568258,-0.000199882532580491,-0.000197329533192793,-0.000194387502189768,-0.000191076853916937,-0.000187427673101706,-0.000183455262365334,-0.000179207714234344,-0.000174529617141063,-0.000169402847814230,-0.000163618667289240,-0.000158018949415700,-0.000151680206294611,-0.000144853300905483,-0.000137836287002851,-0.000130208852792466,-0.000122304146087565,-0.000113862129357035,-0.000105101007151287,-9.58253351879435e-05,-8.62036429931377e-05,-7.60774687790772e-05,-6.55817707343364e-05,-5.45901258446772e-05,-4.32079491175914e-05,-3.13371420015866e-05,-1.90874319254063e-05,-6.36423892882356e-06,6.72881786625523e-06,2.02725334565649e-05,3.41933318200140e-05,4.85802932740687e-05,6.33562523929869e-05,7.85879537845409e-05,9.41869544664300e-05,0.000110184547094262,0.000126520004779281,0.000143247070796478,0.000160378006307342,0.000177909962470110,0.000195762244650225,0.000213802840421803,0.000232363876515895,0.000251228493397062,0.000270258168118653,0.000289757788260316,0.000309398292006235,0.000329410245334704,0.000349578242969569,0.000370058729942597,0.000390679055573274,0.000411564701446612,0.000432572349391452,0.000453804426180025,0.000475140650237663,0.000496653833612151,0.000518223160299353,0.000539924805375925,0.000561630378746770,0.000583415383247494,0.000605178169828918,0.000626988326246855,0.000648730031751405,0.000670462526635224,0.000692064670264031,0.000713586610245625,0.000734940166350071,0.000756185353777146,0.000777237700120953,0.000798088493593085,0.000818632261646721,0.000838913954843450,0.000858966926539473,0.000878651998002375,0.000897905987253512,0.000916913392614175,0.000935366114365612,0.000953473423339302,0.000971014608159791,0.000988111812078887,0.00100459367960148,0.00102055585128607,0.00103585452498303,0.00105056670571297,0.00106456556364283,0.00107790182750726,0.00109045643921030,0.00110228523132443,0.00111325573414441,0.00112343901405834,0.00113271739036513,0.00114114311670278,0.00114859020047773,0.00115511517764205,0.00116059193957559,0.00116508176609189,0.00116848313510148,0.00117084649012647,0.00117205175969895,0.00117211825549406,0.00117095797944823,0.00116864132917285,0.00116507402519985,0.00116021618750133,0.00115403174244438,0.00114662005730991,0.00113773408741808,0.00112757349138885,0.00111592658359303,0.00110290850208325,0.00108837262265163,0.00107240666846423,0.00105488960568621,0.00103589277649554,0.00101530882885424,0.000993190771644534,0.000969446419084525,0.000944132360060626,0.000917144331679176,0.000888565972347503,0.000858288538053036,0.000826375886788465,0.000792728138648682,0.000757420128275276,0.000720351290780250,0.000681606869459327,0.000641098861365158,0.000598891744066572,0.000554888384366379,0.000509158169561096,0.000461640982553265,0.000412413901695766,0.000361374089273545,0.000308580435792453,0.000254008769057457,0.000197733645805768,0.000139603141040577,7.98179328739306e-05,1.82034759469086e-05,-4.50975810885625e-05,-0.000110183144843162,-0.000176947790246052,-0.000245464951475108,-0.000315643825070197,-0.000387545105218133,-0.000461087733878082,-0.000536314859991057,-0.000613145124745944,-0.000691629285516405,-0.000771656234128669,-0.000853301136119801,-0.000936458645922110,-0.00102118076369102,-0.00110735954401475,-0.00119504987498180,-0.00128413071448503,-0.00137465549077038,-0.00146652251081656,-0.00155977622641264,-0.00165429741274010,-0.00175011556973878,-0.00184713064122762,-0.00194539610917186,-0.00204478022615245,-0.00214529748783904,-0.00224685214369623,-0.00234950237910022,-0.00245304997533030,-0.00255761505756522,-0.00266301553765859,-0.00276930144402697,-0.00287634311727017,-0.00298416346946240,-0.00309264685574740,-0.00320180462371768,-0.00331152566068956,-0.00342180757084537,-0.00353254279556277,-0.00364373331928853,-0.00375524789503677,-0.00386712600915252,-0.00397921954022985,-0.00409154709175957,-0.00420397654733794,-0.00431652470358178,-0.00442904697529101,-0.00454156953145279,-0.00465395934043780,-0.00476622182665937,-0.00487821592462962,-0.00498995561442086,-0.00510131991452274,-0.00521231968145750,-0.00532279905778721,-0.00543277501277531,-0.00554212720366259,-0.00565086414733400,-0.00575881253075791,-0.00586605021666464,-0.00597238202857107,-0.00607784367095878,-0.00618230228837368,-0.00628575906913978,-0.00638809804665951,-0.00648931176106527,-0.00658928787303202,-0.00668801306443399,-0.00678538149905634,-0.00688138387466738,-0.00697590029877657,-0.00706896155176380,-0.00716041087508524,-0.00725028006536006,-0.00733844202748897,-0.00742491186214199,-0.00750955984415387,-0.00759241931030825,-0.00767336014202018,-0.00775239472771712,-0.00782940486403380,-0.00790442116394245,-0.00797733126485967,-0.00804815051358994,-0.00811675340400400,-0.00818318507526131,-0.00824733303620469,-0.00830921917722928,-0.00836872353256370,-0.00842591767935821,-0.00848064206322839,-0.00853296367590254,-0.00858277902717725,-0.00863011194548325,-0.00867488321734796,-0.00871711072570144,-0.00875671986509931,-0.00879373050832122,-0.00882807447523599,-0.00885977645127119,-0.00888876108994451,-0.00891508692512842,-0.00893863274132670,-0.00895948918105728,-0.00897755865319830,-0.00899289759347573,-0.00900542861525659,-0.00901522436567392,-0.00902219260122129,-0.00902639698115842,0.990972225950819,-0.00902639698115842,-0.00902219260122129,-0.00901522436567392,-0.00900542861525659,-0.00899289759347573,-0.00897755865319830,-0.00895948918105728,-0.00893863274132670,-0.00891508692512842,-0.00888876108994451,-0.00885977645127119,-0.00882807447523599,-0.00879373050832122,-0.00875671986509931,-0.00871711072570144,-0.00867488321734796,-0.00863011194548325,-0.00858277902717725,-0.00853296367590254,-0.00848064206322839,-0.00842591767935821,-0.00836872353256370,-0.00830921917722928,-0.00824733303620469,-0.00818318507526131,-0.00811675340400400,-0.00804815051358994,-0.00797733126485967,-0.00790442116394245,-0.00782940486403380,-0.00775239472771712,-0.00767336014202018,-0.00759241931030825,-0.00750955984415387,-0.00742491186214199,-0.00733844202748897,-0.00725028006536006,-0.00716041087508524,-0.00706896155176380,-0.00697590029877657,-0.00688138387466738,-0.00678538149905634,-0.00668801306443399,-0.00658928787303202,-0.00648931176106527,-0.00638809804665951,-0.00628575906913978,-0.00618230228837368,-0.00607784367095878,-0.00597238202857107,-0.00586605021666464,-0.00575881253075791,-0.00565086414733400,-0.00554212720366259,-0.00543277501277531,-0.00532279905778721,-0.00521231968145750,-0.00510131991452274,-0.00498995561442086,-0.00487821592462962,-0.00476622182665937,-0.00465395934043780,-0.00454156953145279,-0.00442904697529101,-0.00431652470358178,-0.00420397654733794,-0.00409154709175957,-0.00397921954022985,-0.00386712600915252,-0.00375524789503677,-0.00364373331928853,-0.00353254279556277,-0.00342180757084537,-0.00331152566068956,-0.00320180462371768,-0.00309264685574740,-0.00298416346946240,-0.00287634311727017,-0.00276930144402697,-0.00266301553765859,-0.00255761505756522,-0.00245304997533030,-0.00234950237910022,-0.00224685214369623,-0.00214529748783904,-0.00204478022615245,-0.00194539610917186,-0.00184713064122762,-0.00175011556973878,-0.00165429741274010,-0.00155977622641264,-0.00146652251081656,-0.00137465549077038,-0.00128413071448503,-0.00119504987498180,-0.00110735954401475,-0.00102118076369102,-0.000936458645922110,-0.000853301136119801,-0.000771656234128669,-0.000691629285516405,-0.000613145124745944,-0.000536314859991057,-0.000461087733878082,-0.000387545105218133,-0.000315643825070197,-0.000245464951475108,-0.000176947790246052,-0.000110183144843162,-4.50975810885625e-05,1.82034759469086e-05,7.98179328739306e-05,0.000139603141040577,0.000197733645805768,0.000254008769057457,0.000308580435792453,0.000361374089273545,0.000412413901695766,0.000461640982553265,0.000509158169561096,0.000554888384366379,0.000598891744066572,0.000641098861365158,0.000681606869459327,0.000720351290780250,0.000757420128275276,0.000792728138648682,0.000826375886788465,0.000858288538053036,0.000888565972347503,0.000917144331679176,0.000944132360060626,0.000969446419084525,0.000993190771644534,0.00101530882885424,0.00103589277649554,0.00105488960568621,0.00107240666846423,0.00108837262265163,0.00110290850208325,0.00111592658359303,0.00112757349138885,0.00113773408741808,0.00114662005730991,0.00115403174244438,0.00116021618750133,0.00116507402519985,0.00116864132917285,0.00117095797944823,0.00117211825549406,0.00117205175969895,0.00117084649012647,0.00116848313510148,0.00116508176609189,0.00116059193957559,0.00115511517764205,0.00114859020047773,0.00114114311670278,0.00113271739036513,0.00112343901405834,0.00111325573414441,0.00110228523132443,0.00109045643921030,0.00107790182750726,0.00106456556364283,0.00105056670571297,0.00103585452498303,0.00102055585128607,0.00100459367960148,0.000988111812078887,0.000971014608159791,0.000953473423339302,0.000935366114365612,0.000916913392614175,0.000897905987253512,0.000878651998002375,0.000858966926539473,0.000838913954843450,0.000818632261646721,0.000798088493593085,0.000777237700120953,0.000756185353777146,0.000734940166350071,0.000713586610245625,0.000692064670264031,0.000670462526635224,0.000648730031751405,0.000626988326246855,0.000605178169828918,0.000583415383247494,0.000561630378746770,0.000539924805375925,0.000518223160299353,0.000496653833612151,0.000475140650237663,0.000453804426180025,0.000432572349391452,0.000411564701446612,0.000390679055573274,0.000370058729942597,0.000349578242969569,0.000329410245334704,0.000309398292006235,0.000289757788260316,0.000270258168118653,0.000251228493397062,0.000232363876515895,0.000213802840421803,0.000195762244650225,0.000177909962470110,0.000160378006307342,0.000143247070796478,0.000126520004779281,0.000110184547094262,9.41869544664300e-05,7.85879537845409e-05,6.33562523929869e-05,4.85802932740687e-05,3.41933318200140e-05,2.02725334565649e-05,6.72881786625523e-06,-6.36423892882356e-06,-1.90874319254063e-05,-3.13371420015866e-05,-4.32079491175914e-05,-5.45901258446772e-05,-6.55817707343364e-05,-7.60774687790772e-05,-8.62036429931377e-05,-9.58253351879435e-05,-0.000105101007151287,-0.000113862129357035,-0.000122304146087565,-0.000130208852792466,-0.000137836287002851,-0.000144853300905483,-0.000151680206294611,-0.000158018949415700,-0.000163618667289240,-0.000169402847814230,-0.000174529617141063,-0.000179207714234344,-0.000183455262365334,-0.000187427673101706,-0.000191076853916937,-0.000194387502189768,-0.000197329533192793,-0.000199882532580491,-0.000202089979568258,-0.000203938468290465,-0.000205500615814646,-0.000206744314986457,-0.000207729936684048,-0.000208394590055460,-0.000208818909232947,-0.000208914361672236,-0.000208778412650107,-0.000208320433431508,-0.000207666342939293,-0.000206690532999232,-0.000205567591619151,-0.000204126192811626,-0.000202591272788022,-0.000200721717402619,-0.000198823106324227,-0.000196530327547286,-0.000194365824479820,-0.000191723951020194,-0.000188380534139389,-0.000187043625374363,-0.000183353814877827,-0.000179968089096157,-0.000176506400862890,-0.000173344497693314,-0.000170003610870512,-0.000166672547968535,-0.000163077402430541,-0.000159423339383077,-0.000155563379696214,-0.000151691911348995,-0.000147701206615170,-0.000143750091166411,-0.000139722563575746,-0.000135749879413907,-0.000131721224054881,-0.000127733904568083,-0.000123686613660403,-0.000119675725992680,-0.000115603071499458,-0.000111558728017565,-0.000107471057875890,-0.000103420615461646,-9.93471212987854e-05,-9.53274926874703e-05,-9.13057332852977e-05,-8.73605121160509e-05,-8.34319136996970e-05,-7.95954838563659e-05,-7.57903642155869e-05,-0.000741923098680347];

% Normalize the filter coefficients
b = b / sum(b);

% Filter the signal with b
filtered_signal = filter(b, 1, ecg1);

% Compute the power spectral density of the filtered signal
[Pxx_filtered, f_filtered] = pwelch(filtered_signal, window, noverlap, nfft, fs);

% Plot the power spectral density of both signals
hold on;
plot(f, 10*log10(Pxx_original), 'b', 'LineWidth', 1.5);
plot(f_filtered, 10*log10(Pxx_filtered), 'r', 'LineWidth', 1.5);
hold off;

xlabel('Frequency (Hz)');
ylabel('Power Spectral Density (dB/Hz)');
title('Comparison of Power Spectral Density');
legend('Original Signal', 'Filtered Signal');
grid on;

% Plot the time domain comparison of the original and filtered signal
figure;

% Plot the original signal
subplot(2, 1, 1);
t = (0:length(ecg1)-1) / fs; % Time vector
plot(t, ecg1, 'b', 'LineWidth', 1.5);
xlabel('Time (s)');
ylabel('Amplitude');
title('Original Signal');
grid on;

% Plot the filtered signal
subplot(2, 1, 2);
plot(t, filtered_signal, 'r', 'LineWidth', 1.5);
xlabel('Time (s)');
ylabel('Amplitude');
title('Filtered Signal');
grid on;